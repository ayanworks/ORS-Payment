%% Generated by Sphinx.
\def\sphinxdocclass{report}
\documentclass[a4paper,10pt,english,openany]{sphinxmanual}
\ifdefined\pdfpxdimen
   \let\sphinxpxdimen\pdfpxdimen\else\newdimen\sphinxpxdimen
\fi \sphinxpxdimen=.75bp\relax

\usepackage[utf8]{inputenc}
\ifdefined\DeclareUnicodeCharacter
 \ifdefined\DeclareUnicodeCharacterAsOptional
  \DeclareUnicodeCharacter{"00A0}{\nobreakspace}
  \DeclareUnicodeCharacter{"2500}{\sphinxunichar{2500}}
  \DeclareUnicodeCharacter{"2502}{\sphinxunichar{2502}}
  \DeclareUnicodeCharacter{"2514}{\sphinxunichar{2514}}
  \DeclareUnicodeCharacter{"251C}{\sphinxunichar{251C}}
  \DeclareUnicodeCharacter{"2572}{\textbackslash}
 \else
  \DeclareUnicodeCharacter{00A0}{\nobreakspace}
  \DeclareUnicodeCharacter{2500}{\sphinxunichar{2500}}
  \DeclareUnicodeCharacter{2502}{\sphinxunichar{2502}}
  \DeclareUnicodeCharacter{2514}{\sphinxunichar{2514}}
  \DeclareUnicodeCharacter{251C}{\sphinxunichar{251C}}
  \DeclareUnicodeCharacter{2572}{\textbackslash}
 \fi
\fi
\usepackage{cmap}
\usepackage[T1]{fontenc}
\usepackage{amsmath,amssymb,amstext}
\usepackage{babel}
\usepackage{times}
\usepackage[Bjarne]{fncychap}
\usepackage[dontkeepoldnames]{sphinx}
\sphinxsetup{verbatimwithframe=true,VerbatimBorderColor={rgb}{0.9,0.9,0.9}}
\usepackage{geometry}

% Include hyperref last.
\usepackage{hyperref}
% Fix anchor placement for figures with captions.
\usepackage{hypcap}% it must be loaded after hyperref.
% Set up styles of URL: it should be placed after hyperref.
\urlstyle{same}

\addto\captionsenglish{\renewcommand{\figurename}{Fig.}}
\addto\captionsenglish{\renewcommand{\tablename}{Table}}
\addto\captionsenglish{\renewcommand{\literalblockname}{Listing}}

\addto\captionsenglish{\renewcommand{\literalblockcontinuedname}{continued from previous page}}
\addto\captionsenglish{\renewcommand{\literalblockcontinuesname}{continues on next page}}

\addto\extrasenglish{\def\pageautorefname{page}}

\setcounter{tocdepth}{1}


\usepackage{helvet}
\usepackage{inconsolata}
\renewcommand{\familydefault}{\sfdefault}
\let\stdsection\section
\renewcommand\section{\clearpage\stdsection}


\title{ORS TokenSale Solidity Smart Contracts}
\date{May 10, 2018}
\release{2}
\author{Sicos et al.}
\newcommand{\sphinxlogo}{\vbox{}}
\renewcommand{\releasename}{Release}
\makeindex

\begin{document}

\maketitle
\sphinxtableofcontents
\phantomsection\label{\detokenize{index::doc}}



\chapter{ORSToken}
\label{\detokenize{_contracts/ORSToken:orstoken}}\label{\detokenize{_contracts/ORSToken:tokenplatform-s-solidity-sources}}\label{\detokenize{_contracts/ORSToken::doc}}
\begin{sphinxVerbatim}[commandchars=\\\{\},numbers=left,firstnumber=1,stepnumber=1]
\PYG{k+kr}{pragma} \PYG{n+nx}{solidity} \PYG{l+m+mf}{0.4}\PYG{l+m+mf}{.23}\PYG{p}{;}

\PYG{k+kr}{import} \PYG{l+s+s2}{\PYGZdq{}../zeppelin\PYGZhy{}solidity/contracts/token/ERC20/CappedToken.sol\PYGZdq{}}\PYG{p}{;}
\PYG{k+kr}{import} \PYG{l+s+s2}{\PYGZdq{}../zeppelin\PYGZhy{}solidity/contracts/token/ERC20/PausableToken.sol\PYGZdq{}}\PYG{p}{;}
\PYG{k+kr}{import} \PYG{l+s+s2}{\PYGZdq{}../zeppelin\PYGZhy{}solidity/contracts/token/ERC20/StandardBurnableToken.sol\PYGZdq{}}\PYG{p}{;}


\PYG{c+c1}{/// @title ORSToken}
\PYG{c+c1}{/// @author Sicos et al.}
\PYG{k+kd}{contract} \PYG{n+nx}{ORSToken} \PYG{k+kr}{is} \PYG{n+nx}{CappedToken}\PYG{p}{,} \PYG{n+nx}{StandardBurnableToken}\PYG{p}{,} \PYG{n+nx}{PausableToken} \PYG{p}{\PYGZob{}}

    \PYG{k+kt}{string} \PYG{k+kr}{public} \PYG{n+nx}{name} \PYG{o}{=} \PYG{l+s+s2}{\PYGZdq{}ORS Token\PYGZdq{}}\PYG{p}{;}
    \PYG{k+kt}{string} \PYG{k+kr}{public} \PYG{n+nx}{symbol} \PYG{o}{=} \PYG{l+s+s2}{\PYGZdq{}ORS\PYGZdq{}}\PYG{p}{;}
    \PYG{k+kt}{uint8} \PYG{k+kr}{public} \PYG{n+nx}{decimals} \PYG{o}{=} \PYG{l+m+mi}{18}\PYG{p}{;}

    \PYG{c+c1}{/// @dev Constructor}
    \PYG{c+c1}{/// @param \PYGZus{}cap Maximum number of integral token units; total supply must never exceed this limit}
    \PYG{k+kd}{constructor}\PYG{p}{(}\PYG{k+kt}{uint} \PYG{n+nx}{\PYGZus{}cap}\PYG{p}{)} \PYG{k+kr}{public} \PYG{n+nx}{CappedToken}\PYG{p}{(}\PYG{n+nx}{\PYGZus{}cap}\PYG{p}{)} \PYG{p}{\PYGZob{}}
        \PYG{n+nx}{pause}\PYG{p}{(}\PYG{p}{)}\PYG{p}{;}  \PYG{c+c1}{// Disable token trade}
    \PYG{p}{\PYGZcb{}}

\PYG{p}{\PYGZcb{}}
\end{sphinxVerbatim}


\chapter{ORSTokenSale}
\label{\detokenize{_contracts/ORSTokenSale:orstokensale}}\label{\detokenize{_contracts/ORSTokenSale::doc}}
\begin{sphinxVerbatim}[commandchars=\\\{\},numbers=left,firstnumber=1,stepnumber=1]
\PYG{k+kr}{pragma} \PYG{n+nx}{solidity} \PYG{l+m+mf}{0.4}\PYG{l+m+mf}{.23}\PYG{p}{;}

\PYG{k+kr}{import} \PYG{l+s+s2}{\PYGZdq{}./ORSToken.sol\PYGZdq{}}\PYG{p}{;}
\PYG{k+kr}{import} \PYG{l+s+s2}{\PYGZdq{}./KYCBase.sol\PYGZdq{}}\PYG{p}{;}
\PYG{k+kr}{import} \PYG{l+s+s2}{\PYGZdq{}../eidoo\PYGZhy{}icoengine/contracts/ICOEngineInterface.sol\PYGZdq{}}\PYG{p}{;}
\PYG{k+kr}{import} \PYG{l+s+s2}{\PYGZdq{}../zeppelin\PYGZhy{}solidity/contracts/math/SafeMath.sol\PYGZdq{}}\PYG{p}{;}
\PYG{k+kr}{import} \PYG{l+s+s2}{\PYGZdq{}../zeppelin\PYGZhy{}solidity/contracts/ownership/Ownable.sol\PYGZdq{}}\PYG{p}{;}


\PYG{c+c1}{/// @title ORSTokenSale}
\PYG{c+c1}{/// @author Sicos et al.}
\PYG{k+kd}{contract} \PYG{n+nx}{ORSTokenSale} \PYG{k+kr}{is} \PYG{n+nx}{KYCBase}\PYG{p}{,} \PYG{n+nx}{ICOEngineInterface}\PYG{p}{,} \PYG{n+nx}{Ownable} \PYG{p}{\PYGZob{}}

    \PYG{k+kr}{using} \PYG{n+nx}{SafeMath} \PYG{k}{for} \PYG{k+kt}{uint}\PYG{p}{;}

    \PYG{c+c1}{// Maximum token amounts of each pool}
    \PYG{c+c1}{// Note: BONUS\PYGZus{}CAP should be at least 5\PYGZpc{} of MAINSALE\PYGZus{}CAP}
    \PYG{k+kt}{uint} \PYG{k+kr}{constant} \PYG{k+kr}{public} \PYG{n+nx}{PRESALE\PYGZus{}CAP} \PYG{o}{=} \PYG{l+m+mf}{250000000e18}\PYG{p}{;}                 \PYG{c+c1}{// 250,000,000 e18}
    \PYG{k+kt}{uint} \PYG{k+kr}{constant} \PYG{k+kr}{public} \PYG{n+nx}{MAINSALE\PYGZus{}CAP} \PYG{o}{=} \PYG{l+m+mf}{500000000e18} \PYG{o}{\PYGZhy{}} \PYG{n+nx}{PRESALE\PYGZus{}CAP}\PYG{p}{;}  \PYG{c+c1}{// 250,000,000 e18}
    \PYG{k+kt}{uint} \PYG{k+kr}{constant} \PYG{k+kr}{public} \PYG{n+nx}{BONUS\PYGZus{}CAP} \PYG{o}{=} \PYG{l+m+mf}{64460000e18}\PYG{p}{;}                    \PYG{c+c1}{//  64,460,000 e18}

    \PYG{c+c1}{// Granted token shares that will be minted upon finalization}
    \PYG{k+kt}{uint} \PYG{k+kr}{constant} \PYG{k+kr}{public} \PYG{n+nx}{TEAM\PYGZus{}SHARE} \PYG{o}{=} \PYG{l+m+mf}{83333333e18}\PYG{p}{;}                   \PYG{c+c1}{//  83,333,333 e18}
    \PYG{k+kt}{uint} \PYG{k+kr}{constant} \PYG{k+kr}{public} \PYG{n+nx}{ADVISORS\PYGZus{}SHARE} \PYG{o}{=} \PYG{l+m+mf}{58333333e18}\PYG{p}{;}               \PYG{c+c1}{//  58,333,333 e18}
    \PYG{k+kt}{uint} \PYG{k+kr}{constant} \PYG{k+kr}{public} \PYG{n+nx}{COMPANY\PYGZus{}SHARE} \PYG{o}{=} \PYG{l+m+mf}{127206667e18}\PYG{p}{;}               \PYG{c+c1}{// 127,206,667 e18}

    \PYG{c+c1}{// Remaining token amounts of each pool}
    \PYG{k+kt}{uint} \PYG{k+kr}{public} \PYG{n+nx}{presaleRemaining} \PYG{o}{=} \PYG{n+nx}{PRESALE\PYGZus{}CAP}\PYG{p}{;}
    \PYG{k+kt}{uint} \PYG{k+kr}{public} \PYG{n+nx}{mainsaleRemaining} \PYG{o}{=} \PYG{n+nx}{MAINSALE\PYGZus{}CAP}\PYG{p}{;}
    \PYG{k+kt}{uint} \PYG{k+kr}{public} \PYG{n+nx}{bonusRemaining} \PYG{o}{=} \PYG{n+nx}{BONUS\PYGZus{}CAP}\PYG{p}{;}

    \PYG{c+c1}{// Beneficiaries of granted token shares}
    \PYG{k+kt}{address} \PYG{k+kr}{public} \PYG{n+nx}{teamWallet}\PYG{p}{;}
    \PYG{k+kt}{address} \PYG{k+kr}{public} \PYG{n+nx}{advisorsWallet}\PYG{p}{;}
    \PYG{k+kt}{address} \PYG{k+kr}{public} \PYG{n+nx}{companyWallet}\PYG{p}{;}

    \PYG{n+nx}{ORSToken} \PYG{k+kr}{public} \PYG{n+nx}{token}\PYG{p}{;}

    \PYG{c+c1}{// Integral token units (10\PYGZca{}\PYGZhy{}18 tokens) per wei}
    \PYG{k+kt}{uint} \PYG{k+kr}{public} \PYG{n+nx}{rate}\PYG{p}{;}

    \PYG{c+c1}{// Mainsale period}
    \PYG{k+kt}{uint} \PYG{k+kr}{public} \PYG{n+nx}{openingTime}\PYG{p}{;}
    \PYG{k+kt}{uint} \PYG{k+kr}{public} \PYG{n+nx}{closingTime}\PYG{p}{;}

    \PYG{c+c1}{// Ethereum address where invested funds will be transferred to}
    \PYG{k+kt}{address} \PYG{k+kr}{public} \PYG{n+nx}{wallet}\PYG{p}{;}

    \PYG{c+c1}{// Purchases signed via Eidoo\PYGZsq{}s platform will receive bonus tokens}
    \PYG{k+kt}{address} \PYG{k+kr}{public} \PYG{n+nx}{eidooSigner}\PYG{p}{;}

    \PYG{k+kt}{bool} \PYG{k+kr}{public} \PYG{n+nx}{isFinalized} \PYG{o}{=} \PYG{k+kc}{false}\PYG{p}{;}

    \PYG{c+c1}{/// @dev Log entry on rate changed}
    \PYG{c+c1}{/// @param newRate New rate in integral token units per wei}
    \PYG{k+kd}{event} \PYG{n+nx}{RateChanged}\PYG{p}{(}\PYG{k+kt}{uint} \PYG{n+nx}{newRate}\PYG{p}{)}\PYG{p}{;}

    \PYG{c+c1}{/// @dev Log entry on token purchased}
    \PYG{c+c1}{/// @param buyer Ethereum address of token purchaser}
    \PYG{c+c1}{/// @param value Worth in wei of purchased token amount}
    \PYG{c+c1}{/// @param tokens Number of integral token units}
    \PYG{k+kd}{event} \PYG{n+nx}{TokenPurchased}\PYG{p}{(}\PYG{k+kt}{address} \PYG{k+kt}{indexed} \PYG{n+nx}{buyer}\PYG{p}{,} \PYG{k+kt}{uint} \PYG{n+nx}{value}\PYG{p}{,} \PYG{k+kt}{uint} \PYG{n+nx}{tokens}\PYG{p}{)}\PYG{p}{;}

    \PYG{c+c1}{/// @dev Log entry on buyer refunded upon token purchase}
    \PYG{c+c1}{/// @param buyer Ethereum address of token purchaser}
    \PYG{c+c1}{/// @param value Worth of refund of wei}
    \PYG{k+kd}{event} \PYG{n+nx}{BuyerRefunded}\PYG{p}{(}\PYG{k+kt}{address} \PYG{k+kt}{indexed} \PYG{n+nx}{buyer}\PYG{p}{,} \PYG{k+kt}{uint} \PYG{n+nx}{value}\PYG{p}{)}\PYG{p}{;}

    \PYG{c+c1}{/// @dev Log entry on finalized}
    \PYG{k+kd}{event} \PYG{n+nx}{Finalized}\PYG{p}{(}\PYG{p}{)}\PYG{p}{;}

    \PYG{c+c1}{/// @dev Constructor}
    \PYG{c+c1}{/// @param \PYGZus{}token An ORSToken}
    \PYG{c+c1}{/// @param \PYGZus{}rate Rate in integral token units per wei}
    \PYG{c+c1}{/// @param \PYGZus{}openingTime Block (Unix) timestamp of mainsale start time}
    \PYG{c+c1}{/// @param \PYGZus{}closingTime Block (Unix) timestamp of mainsale latest end time}
    \PYG{c+c1}{/// @param \PYGZus{}wallet Ethereum account who will receive sent ether upon token purchase during mainsale}
    \PYG{c+c1}{/// @param \PYGZus{}teamWallet Ethereum account of team who will receive team share upon finalization}
    \PYG{c+c1}{/// @param \PYGZus{}advisorsWallet Ethereum account of advisors who will receive advisors share upon finalization}
    \PYG{c+c1}{/// @param \PYGZus{}companyWallet Ethereum account of company who will receive company share upon finalization}
    \PYG{c+c1}{/// @param \PYGZus{}kycSigners List of KYC signers\PYGZsq{} Ethereum addresses}
    \PYG{k+kd}{constructor}\PYG{p}{(}
        \PYG{n+nx}{ORSToken} \PYG{n+nx}{\PYGZus{}token}\PYG{p}{,}
        \PYG{k+kt}{uint} \PYG{n+nx}{\PYGZus{}rate}\PYG{p}{,}
        \PYG{k+kt}{uint} \PYG{n+nx}{\PYGZus{}openingTime}\PYG{p}{,}
        \PYG{k+kt}{uint} \PYG{n+nx}{\PYGZus{}closingTime}\PYG{p}{,}
        \PYG{k+kt}{address} \PYG{n+nx}{\PYGZus{}wallet}\PYG{p}{,}
        \PYG{k+kt}{address} \PYG{n+nx}{\PYGZus{}teamWallet}\PYG{p}{,}
        \PYG{k+kt}{address} \PYG{n+nx}{\PYGZus{}advisorsWallet}\PYG{p}{,}
        \PYG{k+kt}{address} \PYG{n+nx}{\PYGZus{}companyWallet}\PYG{p}{,}
        \PYG{k+kt}{address}\PYG{p}{[}\PYG{p}{]} \PYG{n+nx}{\PYGZus{}kycSigners}
    \PYG{p}{)}
        \PYG{k+kr}{public}
        \PYG{n+nx}{KYCBase}\PYG{p}{(}\PYG{n+nx}{\PYGZus{}kycSigners}\PYG{p}{)}
    \PYG{p}{\PYGZob{}}
        \PYG{n+nb}{require}\PYG{p}{(}\PYG{n+nx}{\PYGZus{}token} \PYG{o}{!=} \PYG{k+kt}{address}\PYG{p}{(}\PYG{l+m+mh}{0x0}\PYG{p}{)}\PYG{p}{)}\PYG{p}{;}
        \PYG{n+nb}{require}\PYG{p}{(}\PYG{n+nx}{\PYGZus{}token}\PYG{p}{.}\PYG{n+nx}{cap}\PYG{p}{(}\PYG{p}{)} \PYG{o}{==} \PYG{n+nx}{PRESALE\PYGZus{}CAP} \PYG{o}{+} \PYG{n+nx}{MAINSALE\PYGZus{}CAP} \PYG{o}{+} \PYG{n+nx}{BONUS\PYGZus{}CAP} \PYG{o}{+} \PYG{n+nx}{TEAM\PYGZus{}SHARE} \PYG{o}{+} \PYG{n+nx}{ADVISORS\PYGZus{}SHARE} \PYG{o}{+} \PYG{n+nx}{COMPANY\PYGZus{}SHARE}\PYG{p}{)}\PYG{p}{;}
        \PYG{n+nb}{require}\PYG{p}{(}\PYG{n+nx}{\PYGZus{}rate} \PYG{o}{\PYGZgt{}} \PYG{l+m+mi}{0}\PYG{p}{)}\PYG{p}{;}
        \PYG{n+nb}{require}\PYG{p}{(}\PYG{n+nx}{\PYGZus{}openingTime} \PYG{o}{\PYGZgt{}} \PYG{k+kp}{now} \PYG{o}{\PYGZam{}\PYGZam{}} \PYG{n+nx}{\PYGZus{}closingTime} \PYG{o}{\PYGZgt{}} \PYG{n+nx}{\PYGZus{}openingTime}\PYG{p}{)}\PYG{p}{;}
        \PYG{n+nb}{require}\PYG{p}{(}\PYG{n+nx}{\PYGZus{}wallet} \PYG{o}{!=} \PYG{k+kt}{address}\PYG{p}{(}\PYG{l+m+mh}{0x0}\PYG{p}{)}\PYG{p}{)}\PYG{p}{;}
        \PYG{n+nb}{require}\PYG{p}{(}\PYG{n+nx}{\PYGZus{}teamWallet} \PYG{o}{!=} \PYG{k+kt}{address}\PYG{p}{(}\PYG{l+m+mh}{0x0}\PYG{p}{)} \PYG{o}{\PYGZam{}\PYGZam{}} \PYG{n+nx}{\PYGZus{}companyWallet} \PYG{o}{!=} \PYG{k+kt}{address}\PYG{p}{(}\PYG{l+m+mh}{0x0}\PYG{p}{)} \PYG{o}{\PYGZam{}\PYGZam{}} \PYG{n+nx}{\PYGZus{}advisorsWallet} \PYG{o}{!=} \PYG{k+kt}{address}\PYG{p}{(}\PYG{l+m+mh}{0x0}\PYG{p}{)}\PYG{p}{)}\PYG{p}{;}
        \PYG{n+nb}{require}\PYG{p}{(}\PYG{n+nx}{\PYGZus{}kycSigners}\PYG{p}{.}\PYG{n+nx}{length} \PYG{o}{\PYGZgt{}=} \PYG{l+m+mi}{2}\PYG{p}{)}\PYG{p}{;}

        \PYG{n+nx}{token} \PYG{o}{=} \PYG{n+nx}{\PYGZus{}token}\PYG{p}{;}
        \PYG{n+nx}{rate} \PYG{o}{=} \PYG{n+nx}{\PYGZus{}rate}\PYG{p}{;}
        \PYG{n+nx}{openingTime} \PYG{o}{=} \PYG{n+nx}{\PYGZus{}openingTime}\PYG{p}{;}
        \PYG{n+nx}{closingTime} \PYG{o}{=} \PYG{n+nx}{\PYGZus{}closingTime}\PYG{p}{;}
        \PYG{n+nx}{wallet} \PYG{o}{=} \PYG{n+nx}{\PYGZus{}wallet}\PYG{p}{;}
        \PYG{n+nx}{teamWallet} \PYG{o}{=} \PYG{n+nx}{\PYGZus{}teamWallet}\PYG{p}{;}
        \PYG{n+nx}{advisorsWallet} \PYG{o}{=} \PYG{n+nx}{\PYGZus{}advisorsWallet}\PYG{p}{;}
        \PYG{n+nx}{companyWallet} \PYG{o}{=} \PYG{n+nx}{\PYGZus{}companyWallet}\PYG{p}{;}

        \PYG{n+nx}{eidooSigner} \PYG{o}{=} \PYG{n+nx}{\PYGZus{}kycSigners}\PYG{p}{[}\PYG{l+m+mi}{0}\PYG{p}{]}\PYG{p}{;}
    \PYG{p}{\PYGZcb{}}

    \PYG{c+c1}{/// @dev Set rate, i.e. adjust to changes of fiat/ether exchange rates}
    \PYG{c+c1}{/// @param newRate Rate in integral token units per wei}
    \PYG{k+kd}{function} \PYG{n+nx}{setRate}\PYG{p}{(}\PYG{k+kt}{uint} \PYG{n+nx}{newRate}\PYG{p}{)} \PYG{k+kr}{public} \PYG{n+nx}{onlyOwner} \PYG{p}{\PYGZob{}}
        \PYG{n+nb}{require}\PYG{p}{(}\PYG{n+nx}{newRate} \PYG{o}{\PYGZgt{}} \PYG{l+m+mi}{0}\PYG{p}{)}\PYG{p}{;}

        \PYG{k}{if} \PYG{p}{(}\PYG{n+nx}{newRate} \PYG{o}{!=} \PYG{n+nx}{rate}\PYG{p}{)} \PYG{p}{\PYGZob{}}
            \PYG{n+nx}{rate} \PYG{o}{=} \PYG{n+nx}{newRate}\PYG{p}{;}

            \PYG{k+kr}{emit} \PYG{n+nx}{RateChanged}\PYG{p}{(}\PYG{n+nx}{newRate}\PYG{p}{)}\PYG{p}{;}
        \PYG{p}{\PYGZcb{}}
    \PYG{p}{\PYGZcb{}}

    \PYG{c+c1}{/// @dev Distribute presold tokens and bonus tokens to investors}
    \PYG{c+c1}{/// @param investors List of investors\PYGZsq{} Ethereum addresses}
    \PYG{c+c1}{/// @param tokens List of integral token amounts each investors will receive}
    \PYG{k+kd}{function} \PYG{n+nx}{distributePresale}\PYG{p}{(}\PYG{k+kt}{address}\PYG{p}{[}\PYG{p}{]} \PYG{n+nx}{investors}\PYG{p}{,} \PYG{k+kt}{uint}\PYG{p}{[}\PYG{p}{]} \PYG{n+nx}{tokens}\PYG{p}{)} \PYG{k+kr}{public} \PYG{n+nx}{onlyOwner} \PYG{p}{\PYGZob{}}
        \PYG{n+nb}{require}\PYG{p}{(}\PYG{o}{!}\PYG{n+nx}{isFinalized}\PYG{p}{)}\PYG{p}{;}
        \PYG{n+nb}{require}\PYG{p}{(}\PYG{n+nx}{tokens}\PYG{p}{.}\PYG{n+nx}{length} \PYG{o}{==} \PYG{n+nx}{investors}\PYG{p}{.}\PYG{n+nx}{length}\PYG{p}{)}\PYG{p}{;}

        \PYG{k}{for} \PYG{p}{(}\PYG{k+kt}{uint} \PYG{n+nx}{i} \PYG{o}{=} \PYG{l+m+mi}{0}\PYG{p}{;} \PYG{n+nx}{i} \PYG{o}{\PYGZlt{}} \PYG{n+nx}{investors}\PYG{p}{.}\PYG{n+nx}{length}\PYG{p}{;} \PYG{o}{++}\PYG{n+nx}{i}\PYG{p}{)} \PYG{p}{\PYGZob{}}
            \PYG{n+nx}{presaleRemaining} \PYG{o}{=} \PYG{n+nx}{presaleRemaining}\PYG{p}{.}\PYG{n+nx}{sub}\PYG{p}{(}\PYG{n+nx}{tokens}\PYG{p}{[}\PYG{n+nx}{i}\PYG{p}{]}\PYG{p}{)}\PYG{p}{;}

            \PYG{n+nx}{token}\PYG{p}{.}\PYG{n+nx}{mint}\PYG{p}{(}\PYG{n+nx}{investors}\PYG{p}{[}\PYG{n+nx}{i}\PYG{p}{]}\PYG{p}{,} \PYG{n+nx}{tokens}\PYG{p}{[}\PYG{n+nx}{i}\PYG{p}{]}\PYG{p}{)}\PYG{p}{;}
        \PYG{p}{\PYGZcb{}}
    \PYG{p}{\PYGZcb{}}

    \PYG{c+c1}{/// @dev Finalize, i.e. end token minting phase and enable token trading}
    \PYG{k+kd}{function} \PYG{n+nx}{finalize}\PYG{p}{(}\PYG{p}{)} \PYG{k+kr}{public} \PYG{n+nx}{onlyOwner} \PYG{p}{\PYGZob{}}
        \PYG{n+nb}{require}\PYG{p}{(}\PYG{n+nx}{ended}\PYG{p}{(}\PYG{p}{)} \PYG{o}{\PYGZam{}\PYGZam{}} \PYG{o}{!}\PYG{n+nx}{isFinalized}\PYG{p}{)}\PYG{p}{;}
        \PYG{n+nb}{require}\PYG{p}{(}\PYG{n+nx}{presaleRemaining} \PYG{o}{==} \PYG{l+m+mi}{0}\PYG{p}{)}\PYG{p}{;}

        \PYG{c+c1}{// Distribute granted token shares}
        \PYG{n+nx}{token}\PYG{p}{.}\PYG{n+nx}{mint}\PYG{p}{(}\PYG{n+nx}{teamWallet}\PYG{p}{,} \PYG{n+nx}{TEAM\PYGZus{}SHARE}\PYG{p}{)}\PYG{p}{;}
        \PYG{n+nx}{token}\PYG{p}{.}\PYG{n+nx}{mint}\PYG{p}{(}\PYG{n+nx}{advisorsWallet}\PYG{p}{,} \PYG{n+nx}{ADVISORS\PYGZus{}SHARE}\PYG{p}{)}\PYG{p}{;}
        \PYG{n+nx}{token}\PYG{p}{.}\PYG{n+nx}{mint}\PYG{p}{(}\PYG{n+nx}{companyWallet}\PYG{p}{,} \PYG{n+nx}{COMPANY\PYGZus{}SHARE}\PYG{p}{)}\PYG{p}{;}

        \PYG{c+c1}{// There shouldn\PYGZsq{}t be any remaining presale tokens}
        \PYG{c+c1}{// Remaining mainsale tokens will be lost (i.e. not minted)}
        \PYG{c+c1}{// Remaining bonus tokens will be minted for the benefit of company}
        \PYG{k}{if} \PYG{p}{(}\PYG{n+nx}{bonusRemaining} \PYG{o}{\PYGZgt{}} \PYG{l+m+mi}{0}\PYG{p}{)} \PYG{p}{\PYGZob{}}
            \PYG{n+nx}{token}\PYG{p}{.}\PYG{n+nx}{mint}\PYG{p}{(}\PYG{n+nx}{companyWallet}\PYG{p}{,} \PYG{n+nx}{bonusRemaining}\PYG{p}{)}\PYG{p}{;}
            \PYG{n+nx}{bonusRemaining} \PYG{o}{=} \PYG{l+m+mi}{0}\PYG{p}{;}
        \PYG{p}{\PYGZcb{}}

        \PYG{c+c1}{// Enable token trade}
        \PYG{n+nx}{token}\PYG{p}{.}\PYG{n+nx}{finishMinting}\PYG{p}{(}\PYG{p}{)}\PYG{p}{;}
        \PYG{n+nx}{token}\PYG{p}{.}\PYG{n+nx}{unpause}\PYG{p}{(}\PYG{p}{)}\PYG{p}{;}

        \PYG{n+nx}{isFinalized} \PYG{o}{=} \PYG{k+kc}{true}\PYG{p}{;}

        \PYG{k+kr}{emit} \PYG{n+nx}{Finalized}\PYG{p}{(}\PYG{p}{)}\PYG{p}{;}
    \PYG{p}{\PYGZcb{}}

    \PYG{c+c1}{// false if the ico is not started, true if the ico is started and running, true if the ico is completed}
    \PYG{c+c1}{/// @dev Started (as required by Eidoo\PYGZsq{}s ICOEngineInterface)}
    \PYG{c+c1}{/// @return True iff mainsale start has passed}
    \PYG{k+kd}{function} \PYG{n+nx}{started}\PYG{p}{(}\PYG{p}{)} \PYG{k+kr}{public} \PYG{k+kr}{view} \PYG{k+kr}{returns} \PYG{p}{(}\PYG{k+kt}{bool}\PYG{p}{)} \PYG{p}{\PYGZob{}}
        \PYG{k}{return} \PYG{k+kp}{now} \PYG{o}{\PYGZgt{}=} \PYG{n+nx}{openingTime}\PYG{p}{;}
    \PYG{p}{\PYGZcb{}}

    \PYG{c+c1}{// false if the ico is not started, false if the ico is started and running, true if the ico is completed}
    \PYG{c+c1}{/// @dev Ended (as required by Eidoo\PYGZsq{}s ICOEngineInterface)}
    \PYG{c+c1}{/// @return True iff mainsale is finished}
    \PYG{k+kd}{function} \PYG{n+nx}{ended}\PYG{p}{(}\PYG{p}{)} \PYG{k+kr}{public} \PYG{k+kr}{view} \PYG{k+kr}{returns} \PYG{p}{(}\PYG{k+kt}{bool}\PYG{p}{)} \PYG{p}{\PYGZob{}}
        \PYG{c+c1}{// Note: Even though we allow token holders to burn their tokens immediately after purchase, this won\PYGZsq{}t}
        \PYG{c+c1}{//       affect the early end via \PYGZdq{}sold out\PYGZdq{} as mainsaleRemaining is independent of token.totalSupply.}
        \PYG{k}{return} \PYG{k+kp}{now} \PYG{o}{\PYGZgt{}} \PYG{n+nx}{closingTime} \PYG{o}{\textbar{}\textbar{}} \PYG{n+nx}{mainsaleRemaining} \PYG{o}{==} \PYG{l+m+mi}{0}\PYG{p}{;}
    \PYG{p}{\PYGZcb{}}

    \PYG{c+c1}{// time stamp of the starting time of the ico, must return 0 if it depends on the block number}
    \PYG{c+c1}{/// @dev Start time (as required by Eidoo\PYGZsq{}s ICOEngineInterface)}
    \PYG{c+c1}{/// @return Block (Unix) timestamp of mainsale start time}
    \PYG{k+kd}{function} \PYG{n+nx}{startTime}\PYG{p}{(}\PYG{p}{)} \PYG{k+kr}{public} \PYG{k+kr}{view} \PYG{k+kr}{returns} \PYG{p}{(}\PYG{k+kt}{uint}\PYG{p}{)} \PYG{p}{\PYGZob{}}
        \PYG{k}{return} \PYG{n+nx}{openingTime}\PYG{p}{;}
    \PYG{p}{\PYGZcb{}}

    \PYG{c+c1}{// time stamp of the ending time of the ico, must retrun 0 if it depends on the block number}
    \PYG{c+c1}{/// @dev End time (as required by Eidoo\PYGZsq{}s ICOEngineInterface)}
    \PYG{c+c1}{/// @return Block (Unix) timestamp of mainsale latest end time}
    \PYG{k+kd}{function} \PYG{n+nx}{endTime}\PYG{p}{(}\PYG{p}{)} \PYG{k+kr}{public} \PYG{k+kr}{view} \PYG{k+kr}{returns} \PYG{p}{(}\PYG{k+kt}{uint}\PYG{p}{)} \PYG{p}{\PYGZob{}}
        \PYG{k}{return} \PYG{n+nx}{closingTime}\PYG{p}{;}
    \PYG{p}{\PYGZcb{}}

    \PYG{c+c1}{// returns the total number of the tokens available for the sale, must not change when the ico is started}
    \PYG{c+c1}{/// @dev Total amount of tokens initially available for purchase during mainsale (excluding bonus tokens)}
    \PYG{c+c1}{/// @return Integral token units}
    \PYG{k+kd}{function} \PYG{n+nx}{totalTokens}\PYG{p}{(}\PYG{p}{)} \PYG{k+kr}{public} \PYG{k+kr}{view} \PYG{k+kr}{returns} \PYG{p}{(}\PYG{k+kt}{uint}\PYG{p}{)} \PYG{p}{\PYGZob{}}
        \PYG{k}{return} \PYG{n+nx}{MAINSALE\PYGZus{}CAP}\PYG{p}{;}
    \PYG{p}{\PYGZcb{}}

    \PYG{c+c1}{// returns the number of the tokens available for the ico. At the moment that the ico starts it must be}
    \PYG{c+c1}{// equal to totalTokens(), then it will decrease. It is used to calculate the percentage of sold tokens as}
    \PYG{c+c1}{// remainingTokens() / totalTokens()}
    \PYG{c+c1}{/// @dev Remaining amount of tokens available for purchase during mainsale (excluding bonus tokens)}
    \PYG{c+c1}{/// @return Integral token units}
    \PYG{k+kd}{function} \PYG{n+nx}{remainingTokens}\PYG{p}{(}\PYG{p}{)} \PYG{k+kr}{public} \PYG{k+kr}{view} \PYG{k+kr}{returns} \PYG{p}{(}\PYG{k+kt}{uint}\PYG{p}{)} \PYG{p}{\PYGZob{}}
        \PYG{k}{return} \PYG{n+nx}{mainsaleRemaining}\PYG{p}{;}
    \PYG{p}{\PYGZcb{}}

    \PYG{c+c1}{// return the price as number of tokens released for each ether}
    \PYG{c+c1}{/// @dev Price (as required by Eidoo\PYGZsq{}s ICOEngineInterface); actually the inverse of a \PYGZdq{}price\PYGZdq{}}
    \PYG{c+c1}{/// @return Rate in integral token units per wei}
    \PYG{k+kd}{function} \PYG{n+nx}{price}\PYG{p}{(}\PYG{p}{)} \PYG{k+kr}{public} \PYG{k+kr}{view} \PYG{k+kr}{returns} \PYG{p}{(}\PYG{k+kt}{uint}\PYG{p}{)} \PYG{p}{\PYGZob{}}
        \PYG{k}{return} \PYG{n+nx}{rate}\PYG{p}{;}
    \PYG{p}{\PYGZcb{}}

    \PYG{c+c1}{/// @dev Release purchased tokens to buyers during mainsale (as required by Eidoo\PYGZsq{}s ICOEngineInterface)}
    \PYG{c+c1}{/// @param buyer Ethereum address of purchaser}
    \PYG{c+c1}{/// @param signer Ethereum address of signer}
    \PYG{c+c1}{/// @return Always true, failures will be indicated by transaction reversal}
    \PYG{k+kd}{function} \PYG{n+nx}{releaseTokensTo}\PYG{p}{(}\PYG{k+kt}{address} \PYG{n+nx}{buyer}\PYG{p}{,} \PYG{k+kt}{address} \PYG{n+nx}{signer}\PYG{p}{)} \PYG{k+kr}{internal} \PYG{k+kr}{returns} \PYG{p}{(}\PYG{k+kt}{bool}\PYG{p}{)} \PYG{p}{\PYGZob{}}
        \PYG{n+nb}{require}\PYG{p}{(}\PYG{n+nx}{started}\PYG{p}{(}\PYG{p}{)} \PYG{o}{\PYGZam{}\PYGZam{}} \PYG{o}{!}\PYG{n+nx}{ended}\PYG{p}{(}\PYG{p}{)}\PYG{p}{)}\PYG{p}{;}

        \PYG{k+kt}{uint} \PYG{n+nx}{value} \PYG{o}{=} \PYG{n+nx}{msg}\PYG{p}{.}\PYG{n+nx}{value}\PYG{p}{;}
        \PYG{k+kt}{uint} \PYG{n+nx}{refund} \PYG{o}{=} \PYG{l+m+mi}{0}\PYG{p}{;}

        \PYG{k+kt}{uint} \PYG{n+nx}{tokens} \PYG{o}{=} \PYG{n+nx}{value}\PYG{p}{.}\PYG{n+nx}{mul}\PYG{p}{(}\PYG{n+nx}{rate}\PYG{p}{)}\PYG{p}{;}
        \PYG{k+kt}{uint} \PYG{n+nx}{bonus} \PYG{o}{=} \PYG{l+m+mi}{0}\PYG{p}{;}

        \PYG{c+c1}{// (Last) buyer whose purchase would exceed available mainsale tokens will be partially refunded}
        \PYG{k}{if} \PYG{p}{(}\PYG{n+nx}{tokens} \PYG{o}{\PYGZgt{}} \PYG{n+nx}{mainsaleRemaining}\PYG{p}{)} \PYG{p}{\PYGZob{}}
            \PYG{k+kt}{uint} \PYG{n+nx}{valueOfRemaining} \PYG{o}{=} \PYG{n+nx}{mainsaleRemaining}\PYG{p}{.}\PYG{n+nx}{div}\PYG{p}{(}\PYG{n+nx}{rate}\PYG{p}{)}\PYG{p}{;}

            \PYG{n+nx}{refund} \PYG{o}{=} \PYG{n+nx}{value}\PYG{p}{.}\PYG{n+nx}{sub}\PYG{p}{(}\PYG{n+nx}{valueOfRemaining}\PYG{p}{)}\PYG{p}{;}
            \PYG{n+nx}{value} \PYG{o}{=} \PYG{n+nx}{valueOfRemaining}\PYG{p}{;}
            \PYG{n+nx}{tokens} \PYG{o}{=} \PYG{n+nx}{mainsaleRemaining}\PYG{p}{;}
            \PYG{c+c1}{// Note:}
            \PYG{c+c1}{// To be 100\PYGZpc{} accurate the buyer should receive only a token amount that corresponds to valueOfRemaining,}
            \PYG{c+c1}{// i.e. tokens = valueOfRemaining.mul(rate), because of mainsaleRemaining may not be a multiple of rate}
            \PYG{c+c1}{// (due to regular adaption to the ether/fiat exchange rate).}
            \PYG{c+c1}{// Nevertheless, we deliver all mainsaleRemaining tokens as the worth of these additional tokens at time}
            \PYG{c+c1}{// of purchase is less than a wei and the gas costs of a correct solution, i.e. calculate value * rate}
            \PYG{c+c1}{// again, would exceed this by several orders of magnitude.}
        \PYG{p}{\PYGZcb{}}

        \PYG{c+c1}{// Purchases signed via Eidoo\PYGZsq{}s platform will receive additional 5\PYGZpc{} bonus tokens}
        \PYG{k}{if} \PYG{p}{(}\PYG{n+nx}{signer} \PYG{o}{==} \PYG{n+nx}{eidooSigner}\PYG{p}{)} \PYG{p}{\PYGZob{}}
            \PYG{n+nx}{bonus} \PYG{o}{=} \PYG{n+nx}{tokens}\PYG{p}{.}\PYG{n+nx}{div}\PYG{p}{(}\PYG{l+m+mi}{20}\PYG{p}{)}\PYG{p}{;}
        \PYG{p}{\PYGZcb{}}

        \PYG{n+nx}{mainsaleRemaining} \PYG{o}{=} \PYG{n+nx}{mainsaleRemaining}\PYG{p}{.}\PYG{n+nx}{sub}\PYG{p}{(}\PYG{n+nx}{tokens}\PYG{p}{)}\PYG{p}{;}
        \PYG{n+nx}{bonusRemaining} \PYG{o}{=} \PYG{n+nx}{bonusRemaining}\PYG{p}{.}\PYG{n+nx}{sub}\PYG{p}{(}\PYG{n+nx}{bonus}\PYG{p}{)}\PYG{p}{;}

        \PYG{n+nx}{token}\PYG{p}{.}\PYG{n+nx}{mint}\PYG{p}{(}\PYG{n+nx}{buyer}\PYG{p}{,} \PYG{n+nx}{tokens}\PYG{p}{.}\PYG{n+nx}{add}\PYG{p}{(}\PYG{n+nx}{bonus}\PYG{p}{)}\PYG{p}{)}\PYG{p}{;}
        \PYG{n+nx}{wallet}\PYG{p}{.}\PYG{n+nx}{transfer}\PYG{p}{(}\PYG{n+nx}{value}\PYG{p}{)}\PYG{p}{;}
        \PYG{k}{if} \PYG{p}{(}\PYG{n+nx}{refund} \PYG{o}{\PYGZgt{}} \PYG{l+m+mi}{0}\PYG{p}{)} \PYG{p}{\PYGZob{}}
            \PYG{n+nx}{buyer}\PYG{p}{.}\PYG{n+nx}{transfer}\PYG{p}{(}\PYG{n+nx}{refund}\PYG{p}{)}\PYG{p}{;}

            \PYG{k+kr}{emit} \PYG{n+nx}{BuyerRefunded}\PYG{p}{(}\PYG{n+nx}{buyer}\PYG{p}{,} \PYG{n+nx}{refund}\PYG{p}{)}\PYG{p}{;}
        \PYG{p}{\PYGZcb{}}

        \PYG{k+kr}{emit} \PYG{n+nx}{TokenPurchased}\PYG{p}{(}\PYG{n+nx}{buyer}\PYG{p}{,} \PYG{n+nx}{value}\PYG{p}{,} \PYG{n+nx}{tokens}\PYG{p}{.}\PYG{n+nx}{add}\PYG{p}{(}\PYG{n+nx}{bonus}\PYG{p}{)}\PYG{p}{)}\PYG{p}{;}

        \PYG{k}{return} \PYG{k+kc}{true}\PYG{p}{;}
    \PYG{p}{\PYGZcb{}}

\PYG{p}{\PYGZcb{}}
\end{sphinxVerbatim}



\renewcommand{\indexname}{Index}
\printindex
\end{document}